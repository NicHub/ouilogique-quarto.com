<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nico">

<title>Mise en route d’une carte WeMos-LoLin avec le firmware NodeMCU et un module WiFi ESP8266 – ouilogique.com</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<link href="../.././images/favicon.ico" rel="icon">
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "Pas de résultats",
    "search-matching-documents-text": "documents trouvés",
    "search-copy-link-title": "Copier le lien vers la recherche",
    "search-hide-matches-text": "Cacher les correspondances additionnelles",
    "search-more-match-text": "correspondance de plus dans ce document",
    "search-more-matches-text": "correspondances de plus dans ce document",
    "search-clear-button-title": "Effacer",
    "search-detached-cancel-button-title": "Annuler",
    "search-submit-button-title": "Envoyer",
    "search-label": "Recherche"
  }
}</script>


</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand navbar-dark ">
      <div class="navbar-container container-fluid">
          <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text"><i class="fa-regular fa-house" aria-label="house"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/NicHub" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Mise en route d’une carte <em>WeMos-LoLin</em> avec le firmware NodeMCU et un module WiFi ESP8266</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Auteur·rice</div>
    <div class="quarto-title-meta-contents">
             <p>Nico </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Date de publication</div>
    <div class="quarto-title-meta-contents">
      <p class="date">27 septembre 2015</p>
    </div>
  </div>
  
    
  </div>
  

</header>


<blockquote class="blockquote">
<p>Voir aussi <a href="../../NodeMCU_esp8266_amica/">l’article sur l’ESP8266 Amica</a></p>
</blockquote>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./images/NodeMCU_esp8266_001.jpg"><img src="./images/NodeMCU_esp8266_001.jpg" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">ouilogique.com</figcaption>
</figure>
</div>
<section id="firmware-nodemcu" class="level2">
<h2 class="anchored" data-anchor-id="firmware-nodemcu">Firmware NodeMCU</h2>
<ul>
<li><a href="http://nodemcu.com/index_en.html" class="uri">http://nodemcu.com/index_en.html</a></li>
</ul>
</section>
<section id="référence-de-la-carte-chez-banggood" class="level2">
<h2 class="anchored" data-anchor-id="référence-de-la-carte-chez-banggood">Référence de la carte chez Banggood</h2>
<ul>
<li><a href="http://www.banggood.com/V3-NodeMcu-Lua-WIFI-Development-Board-p-992733.html?p=0431091025639201412F" class="uri">http://www.banggood.com/V3-NodeMcu-Lua-WIFI-Development-Board-p-992733.html?p=0431091025639201412F</a></li>
</ul>
<blockquote class="blockquote">
<p>AliExpress propose des versions moins chères avec un chip <code>silabs cp2102</code> au lieu du <code>CH340G</code> pour la communication USB.</p>
<p>Cette carte utilise un ESP8266 ESP-12E (d’après l’apparence). <a href="http://www.esp8266.com/wiki/doku.php?id=esp8266-module-family">Voir les différentes versions de l’ESP8266</a>.</p>
</blockquote>
</section>
<section id="référence-fabricant" class="level2">
<h2 class="anchored" data-anchor-id="référence-fabricant">Référence fabricant</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./images/NodeMCU_esp8266_002_lowres.jpg"><img src="./images/NodeMCU_esp8266_002_lowres.jpg" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">ouilogique.com</figcaption>
</figure>
</div>
<p>La carte est donc une <em>LoLin</em> du fabricant <a href="http://www.wemos.cc/">WeMos</a></p>
<p>La page de la carte en question&nbsp;: <a href="http://www.wemos.cc/wiki/">www.wemos.cc/wiki/</a></p>
<blockquote class="blockquote">
<p>L’ESP8266 a été développé par <a href="http://espressif.com">Espressif</a>. D’après <a href="http://www.allaboutcircuits.com/projects/guts-of-the-iot-part-1-building-nodemcu-from-source-for-the-esp8266/">cet article</a>, il semblerait que l’ESP8266 a d’abord été vendu comme une passerelle UART pour les microcontrôleurs, mais qu’en fait il contient <a href="http://ip.cadence.com/uploads/pdf/LX3.pdf">un processeur 32-bit Tensilica Xtensa LX106 à 80&nbsp;MHz avec un “full WiFi stack”</a>.</p>
</blockquote>
</section>
<section id="communication-usb" class="level2">
<h2 class="anchored" data-anchor-id="communication-usb">Communication USB</h2>
<p>⚠ Cette carte utilise une puce CH340G pour la communication USB. Pour l’installation du pilote sur OSX, voir l’article <a href="../../ch340_driver/"><em>Utiliser un chip CH340G au lieu d’un FTDI</em></a>.</p>
<p>Sur le site du fabricant, il y a deux drivers pour Mac&nbsp;:</p>
<p><a href="http://66.175.219.73/downloads/ch340/CH341SER_MAC66972.ZIP">Mac (old) ⇒ MD5 = 505487fe1033a9485f2e3fb0520718e8</a></p>
<p><a href="http://www.wemos.cc/wiki/uploads/Tutorial/ch341ser_mac_new.zip">Mac (new) ⇒ MD5 = f2c61b093909d6d54f6a466e7e367a39</a></p>
<p>La version “old” a le même MD5 que celle disponible à <a href="http://www.wch.cn/download/CH341SER_MAC_ZIP.html" class="uri">http://www.wch.cn/download/CH341SER_MAC_ZIP.html</a>.</p>
<p>Il me semble que la version “new” ne nécessite pas d’enlever la protection d’OSX contre les pilotes non signés ⇒ à vérifier.</p>
<section id="adresse-de-la-carte" class="level3">
<h3 class="anchored" data-anchor-id="adresse-de-la-carte">Adresse de la carte</h3>
<p>Sur mon MacBook Pro, l’adresse de la carte est <code>/dev/tty.wchusbserial1410</code> sur le port USB de gauche ou <code>/dev/tty.wchusbserial1420</code> sur le port USB de droite.</p>
<blockquote class="blockquote">
<p>À noter que je ne branche jamais de cartes de développement sur mon clavier externe, car ce clavier est un hub sans alimentation qui consomme donc du courant sur le port USB. Quand on connecte une carte, il y a le risque que le Mac fasse un <em>reboot</em> comme si on lui avait enlevé l’alimentation et comme ça m’est déjà arrivé, je ne recommence plus.</p>
<p>D’ailleurs, les ports USB sous-alimentés du Raspberry Π ne supportent pas ce clavier pour la même raison&nbsp;: il consomme trop <a href="http://www.banggood.com/USB-Detector-Current-Voltage-Tester-Double-USB-Row-Shows-p-973712.html?p=0431091025639201412F">(50&nbsp;mA mesuré)</a>.</p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> /dev <span class="kw">|</span> <span class="fu">grep</span> tty.wchusbserial <span class="co"># retourne par ex&nbsp;: tty.wchusbserial1410</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> /dev/tty.wchusbserial1410 <span class="co"># adresse OK si cette commande retourne quelque chose</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="mise-à-jour-du-firmware" class="level2">
<h2 class="anchored" data-anchor-id="mise-à-jour-du-firmware">Mise à jour du firmware</h2>
<section id="installer-esptool" class="level3">
<h3 class="anchored" data-anchor-id="installer-esptool">Installer <code>esptool</code></h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/themadinventor/esptool.git</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> esptool</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> setup.py install</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span> esptool.py <span class="co"># ⇒ /usr/local/bin/esptool.py</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="télécharger-le-dernier-firmware" class="level3">
<h3 class="anchored" data-anchor-id="télécharger-le-dernier-firmware">Télécharger le dernier firmware</h3>
<blockquote class="blockquote">
<p>Par défaut la carte est livrée avec le firmware floating point La dernière version (nodemcu_float_0.9.6-dev_20150704.bin) fonctionne pour moi.</p>
</blockquote>
<ul>
<li><a href="http://www.wemos.cc/wiki/Tutorial/Downloads#firmware" class="uri">http://www.wemos.cc/wiki/Tutorial/Downloads#firmware</a></li>
</ul>
</section>
<section id="flasher-le-firmware" class="level3">
<h3 class="anchored" data-anchor-id="flasher-le-firmware">Flasher le firmware</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">USBPORT</span><span class="op">=</span>/dev/tty.wchusbserial1410</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="va">FIRMWARE</span><span class="op">=</span>nodemcu_float_0.9.6-dev_20150704.bin</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">esptool.py</span>           <span class="dt">\</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--port</span> <span class="va">$USBPORT</span>  <span class="dt">\</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--baud</span> 230400    <span class="dt">\</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    write_flash      <span class="dt">\</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--flash_mode</span> qio <span class="dt">\</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--flash_size</span> 32m <span class="dt">\</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--flash_freq</span> 40m <span class="dt">\</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    0x00000 <span class="va">$FIRMWARE</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="pinout" class="level2">
<h2 class="anchored" data-anchor-id="pinout">Pinout</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./images/NodeMCU_esp8266_lolin_pinout.jpg"><img src="./images/NodeMCU_esp8266_lolin_pinout.jpg" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">ouilogique.com</figcaption>
</figure>
</div>
</section>
<section id="programmation-de-lesp8266" class="level2">
<h2 class="anchored" data-anchor-id="programmation-de-lesp8266">Programmation de l’ESP8266</h2>
<p>L’ESP8266 peut être programmé de plusieurs façons&nbsp;:</p>
<ul>
<li><a href="#programmation-en-arduino-c">En Arduino C (voir ci-dessous)</a></li>
<li>En C, avec <a href="http://bbs.espressif.com">le SDK d’Espressif</a></li>
<li>En C, avec <a href="https://github.com/SmingHub/Sming">Sming</a></li>
<li><a href="#programmation-en-lua">En Lua (voir ci-dessous)</a></li>
<li>En JavaScript, avec le firmware <a href="http://www.espruino.com/">Espruino</a></li>
<li>En <a href="https://micropython.org">MicroPython</a></li>
<li>En <a href="http://www.esp8266basic.com">BASIC</a></li>
</ul>
<p>{: #programmation-en-arduino-c }</p>
</section>
<section id="programmation-de-lesp8266-en-arduino-c" class="level2">
<h2 class="anchored" data-anchor-id="programmation-de-lesp8266-en-arduino-c">Programmation de l’ESP8266 en&nbsp;Arduino C</h2>
<p>Les informations d’origine se trouvent ici&nbsp;: <a href="https://github.com/esp8266/Arduino/" class="uri">https://github.com/esp8266/Arduino/</a></p>
<section id="configuration-de-lide-arduino" class="level3">
<h3 class="anchored" data-anchor-id="configuration-de-lide-arduino">Configuration de l’IDE Arduino</h3>
<blockquote class="blockquote">
<p>À faire une fois</p>
</blockquote>
<ul>
<li>Télécharger et installer, <a href="https://www.arduino.cc/en/Main/Software">l’IDE Arduino</a></li>
<li>Ouvrir les préférences de l’IDE Arduino</li>
<li>Cliquer sur “URL de gestionnaire de cartes supplémentaires” et coller le lien suivant&nbsp;:</li>
</ul>
<p><code>http://arduino.esp8266.com/stable/package_esp8266com_index.json</code></p>
<ul>
<li>Installer la bibliothèque “esp8266 by ESP8266 Community” (Outils/Type de carte/Gestionnaire de carte)</li>
</ul>
<p>La bibliothèque est installée au chemin suivant&nbsp;:</p>
<pre><code>~/Library/Arduino15/packages/esp8266/hardware/esp8266/</code></pre>
<blockquote class="blockquote">
<p>Note&nbsp;: Adafruit et LoLin proposent d’autres gestionnaires. J’ai choisi la version de la communauté qui maintient le site <a href="http://www.esp8266.com">esp8266.com</a>. <a href="https://github.com/adafruit/ESP8266-Arduino">La version d’Adafruit</a> est un <em>fork</em> de celle d’<em>esp8266.com</em>.</p>
</blockquote>
</section>
<section id="configuration-de-la-carte-dans-lide" class="level3">
<h3 class="anchored" data-anchor-id="configuration-de-la-carte-dans-lide">Configuration de la carte dans l’IDE</h3>
<blockquote class="blockquote">
<p>À faire pour chaque ESP différent. Exemple pour le LoLin (ESP-12E).</p>
</blockquote>
<p>Dans le menu <code>Outils</code></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./images/esp8266-configuration-arduino-c.png"><img src="./images/esp8266-configuration-arduino-c.png" class="img-fluid figure-img"></a></p>
<figcaption class="figure-caption">ouilogique.com</figcaption>
</figure>
</div>
<blockquote class="blockquote">
<p>L’ESP8266 peut être overclocké à 160&nbsp;MHz. J’ai observé que la librairie <code>Tone.h</code> n’aime pas ça…</p>
</blockquote>
<p>{: #compilation-et-telechargement }</p>
</section>
<section id="compilation-et-téléchargement-des-programmes" class="level3">
<h3 class="anchored" data-anchor-id="compilation-et-téléchargement-des-programmes">Compilation et téléchargement des programmes</h3>
<p>La compilation et le téléchargement se font exactement comme pour une carte Arduino. Pour la programmation, il peut y avoir quelques différences de fonctionnalité liées aux différences du hardware et à l’implémentation des bibliothèques. Il y a <a href="https://github.com/esp8266/Arduino/blob/master/doc/libraries.md">quelques informations sur le GitHub d’ESP8266</a> et Adafruit a aussi documenté quelques différences sur <a href="https://github.com/adafruit/ESP8266-Arduino">leur <em>fork</em></a>.</p>
</section>
<section id="gestionnaire-de-téléchargement-esp8266fs" class="level3">
<h3 class="anchored" data-anchor-id="gestionnaire-de-téléchargement-esp8266fs">Gestionnaire de téléchargement <em>esp8266fs</em></h3>
<p>L’ESP8266 dispose d’un système de fichiers SPIFFS et on peut donc télécharger des fichiers depuis un ordinateur sur l’ESP8266 via l’IDE Arduino. Pour ce faire, il faut installer un gestionnaire de téléchargements appelé <em>esp8266fs</em>. Les instructions se trouvent ici&nbsp;:</p>
<ul>
<li><a href="https://github.com/esp8266/arduino-esp8266fs-plugin/" class="uri">https://github.com/esp8266/arduino-esp8266fs-plugin/</a></li>
</ul>
<p>Il y a également quelques informations sur cette page&nbsp;:</p>
<ul>
<li><a href="http://esp8266.github.io/Arduino/versions/2.0.0/doc/filesystem.html#uploading-files-to-file-system" class="uri">http://esp8266.github.io/Arduino/versions/2.0.0/doc/filesystem.html#uploading-files-to-file-system</a></li>
</ul>
<blockquote class="blockquote">
<p>Ce gestionnaire de téléchargement ne sert pas à programmer l’ESP8266 (voir <a href="#compilation-et-telechargement"><em>Compilation et téléchargement</em></a> pour cette fonctionnalité), mais à télécharger des fichiers annexes, typiquement des fichiers qui seront servis par une interface web (HTML, images…) ou des fichiers de configuration.</p>
</blockquote>
<p>L’utilisation est très simple&nbsp;:</p>
<ul>
<li>Créer un répertoire <code>data</code> dans le dossier du croquis.</li>
<li>Y copier les fichiers.</li>
<li>Utiliser la fonction <code>ESP8266 Sketch Data Upload</code> dans le menu <code>Outils</code> (voir image du menu <code>Outils</code> ci-dessus).</li>
</ul>
<p>Le gros problème de cette façon de faire, c’est que le téléchargement prend beaucoup de temps quelle que soit la taille du répertoire <code>data</code>, car l’entier de la mémoire disponible est flashé.</p>
<p>À 115’200 bauds, il faut environ 2&nbsp;min&nbsp;pour une <em>Flash Size SPIFFS</em> d’1&nbsp;Mo et 6&nbsp;min pour une <em>Flash Size SPIFFS</em> de 3&nbsp;Mo (réglage <code>Flash Size</code> dans le menu <code>Outils</code>, voir image ci-dessus). On peut diminuer ces temps d’un facteur&nbsp;2 en utilisant une vitesse de transmission de 230’400&nbsp;bauds. Au delà l’IDE génère une erreur. À noter que même à 115’200 bauds, l’IDE plante de temps en temps et qu’il est nécessaire de le redémarrer et de débrancher et rebrancher l’ESP8266 également.</p>
</section>
<section id="exemples-de-programme" class="level3">
<h3 class="anchored" data-anchor-id="exemples-de-programme">Exemples de programme</h3>
<p><a href="https://github.com/NicHub/ouilogique-ESP8266-Arduino/blob/master/blink/blink.ino">Blink ESP8266</a></p>
<p><a href="https://github.com/NicHub/ouilogique-ESP8266-Arduino/blob/master/get-esp8266-info/get-esp8266-info.ino">Affiche quelques caractéristiques de l’ESP8266 dans la console série</a></p>
</section>
<section id="notes" class="level3">
<h3 class="anchored" data-anchor-id="notes">Notes</h3>
<ul>
<li>Sur OSX, les bibliothèques sont installées dans le répertoire <code>~/Library/Arduino15/packages/</code>.</li>
<li>Quelques variables utiles sont définies dans le fichier <code>~/Library/Arduino15/packages/esp8266/hardware/esp8266/2.2.0/variants/nodemcu/pins_arduino.h</code>.</li>
</ul>
<p>{: #programmation-en-lua }</p>
</section>
</section>
<section id="programmation-de-lesp8266-en-lua" class="level2">
<h2 class="anchored" data-anchor-id="programmation-de-lesp8266-en-lua">Programmation de l’ESP8266 en&nbsp;Lua</h2>
<p>Les scripts Lua peuvent être interprétés ou compilés avec le firmware <a href="http://nodemcu.com/index_en.html">NodeMCU</a>.</p>
<p>On trouve quantité de programmes sur le web pour charger les scripts Lua sur l’ESP8266. J’ai testé les suivants&nbsp;:</p>
<ul>
<li><a href="#esplorer">esplorer</a></li>
<li><a href="#esp8266-nodejs">esp8266 (Node.js)</a></li>
<li><a href="#luatool">luatool</a></li>
<li><a href="#nodemcu-uploader">nodemcu-uploader</a></li>
<li><a href="#la-main">upload à la main</a></li>
</ul>
<section id="esplorer" class="level3">
<h3 class="anchored" data-anchor-id="esplorer">Esplorer</h3>
<p>Esplorer est un programme java avec une interface graphique assez moche. Au-delà de son aspect, il est rapide et stable et c’est celui que j’utilise en ce moment.</p>
<ul>
<li><p><a href="http://esp8266.ru/esplorer/" class="uri">http://esp8266.ru/esplorer/</a></p></li>
<li><p><a href="http://esp8266.ru/esplorer-latest/?f=ESPlorer.zip" class="uri">http://esp8266.ru/esplorer-latest/?f=ESPlorer.zip</a></p></li>
</ul>
</section>
<section id="esp8266-node.js" class="level3">
<h3 class="anchored" data-anchor-id="esp8266-node.js">esp8266 (Node.js)</h3>
<p>Il faut avoir installé <a href="https://nodejs.org">Node.js</a> au préalable. Ne fonctionne pas avec la version 4.2.1 de Node.js, mais fonctionne avec la version 0.12.7.</p>
<ul>
<li><a href="https://www.npmjs.com/package/esp8266" class="uri">https://www.npmjs.com/package/esp8266</a></li>
</ul>
<p>La vitesse de transmission est fixée à 9600&nbsp;bits/s et ne peut pas être changée.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Installation</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install esp8266 <span class="at">-g</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Définition du port</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">esp</span> port set /dev/tty.wchusbserial1410</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Liste des fichiers</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">esp</span> file list</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Chargement d’une version compressée des scripts</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="ex">esp</span> file push init.lua</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="luatool" class="level3">
<h3 class="anchored" data-anchor-id="luatool">luatool</h3>
<ul>
<li><a href="https://github.com/4refr0nt/luatool" class="uri">https://github.com/4refr0nt/luatool</a></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/4refr0nt/luatool.git</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># upload.sh ⇒ upload les scripts Lua avec luatool</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/4refr0nt/luatool</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="va">USBPORT</span><span class="op">=</span>/dev/tty.wchusbserial1420</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">./luatool/luatool/luatool.py</span>  <span class="dt">\</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--port</span> <span class="va">$USBPORT</span>           <span class="dt">\</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--src</span>  init_1.lua         <span class="dt">\</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--dest</span> init.lua           <span class="dt">\</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">--verbose</span>                 <span class="dt">\</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--restart</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="nodemcu-uploader" class="level3">
<h3 class="anchored" data-anchor-id="nodemcu-uploader">nodemcu-uploader</h3>
<ul>
<li><a href="https://github.com/kmpm/nodemcu-uploader" class="uri">https://github.com/kmpm/nodemcu-uploader</a></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/kmpm/nodemcu-uploader.git</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># upload.sh ⇒ upload les scripts Lua avec nodemcu-uploader</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/kmpm/nodemcu-uploader</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="va">USBPORT</span><span class="op">=</span>/dev/tty.wchusbserial1420</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="va">BAUD</span><span class="op">=</span>115200</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="ex">./nodemcu-uploader/nodemcu-uploader.py</span> <span class="dt">\</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--port</span> <span class="va">$USBPORT</span>                    <span class="dt">\</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--baud</span> <span class="va">$BAUD</span>                       <span class="dt">\</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    upload                             <span class="dt">\</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    init1.lua:init.lua                 <span class="dt">\</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--restart</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="à-la-main" class="level3">
<h3 class="anchored" data-anchor-id="à-la-main">À la main</h3>
<blockquote class="blockquote">
<p>On peut aussi envoyer le fichier ligne par ligne à la main avec des logiciels comme <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/screen.1.html">screen</a> ou <a href="http://freeware.the-meiers.org">CoolTerm</a></p>
</blockquote>
<blockquote class="blockquote">
<p>Par défaut la vitesse de communication est de 9600 bits/s. Avec luatool, on ne peut aller qu’à cette vitesse. Avec nodemcu-uploader on peut aller plus haut. J’ai testé à 115200 bits/s et ça fonctionne, mais la commnunication se bloque de temps en temps. Il me semble qu’il est plus sage de travailler uniquement à 9600 bits/s.</p>
</blockquote>
</section>
</section>
<section id="hello-world" class="level2">
<h2 class="anchored" data-anchor-id="hello-world">Hello World</h2>
<p>Créer un fichier <code>init_1.lua</code></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- init_1.lua</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- Fait clignoter la LED de l’ESP8266</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="va">led1</span> <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="va">gpio</span><span class="op">.</span>mode<span class="op">(</span> <span class="va">led1</span><span class="op">,</span> <span class="va">gpio</span><span class="op">.</span><span class="cn">OUTPUT</span> <span class="op">)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">i</span><span class="op">=</span><span class="dv">1</span><span class="op">,</span><span class="dv">10</span> <span class="cf">do</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">gpio</span><span class="op">.</span>write<span class="op">(</span> <span class="va">led1</span><span class="op">,</span> <span class="va">gpio</span><span class="op">.</span><span class="cn">HIGH</span> <span class="op">)</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">tmr</span><span class="op">.</span>delay<span class="op">(</span> <span class="dv">0.1E6</span> <span class="op">)</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">gpio</span><span class="op">.</span>write<span class="op">(</span> <span class="va">led1</span><span class="op">,</span> <span class="va">gpio</span><span class="op">.</span><span class="cn">LOW</span> <span class="op">)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">tmr</span><span class="op">.</span>delay<span class="op">(</span> <span class="dv">1E6</span> <span class="op">)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span><span class="op">(</span> <span class="st">"Coucou, c'est moi !"</span> <span class="op">)</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Pour l’upload, créer un fichier <code>upload.sh</code> (voir ci-dessus).</p>
<p>Alternativement, il est possible d’envoyer le fichier ligne par ligne avec <a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/screen.1.html">screen</a> ou <a href="http://freeware.the-meiers.org">CoolTerm</a>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">file.open</span><span class="er">(</span> <span class="st">"init.lua"</span><span class="ex">,</span> <span class="st">"w"</span> <span class="kw">)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span> led1 <span class="ot">=</span> 4                          <span class="kw">]])</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span> gpio.mode<span class="op">(</span> led1, gpio.OUTPUT <span class="op">)</span>    <span class="kw">]])</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span> for i=1,10 do                     <span class="kw">]])</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span>     gpio.write<span class="op">(</span> led1, gpio.HIGH <span class="op">)</span> <span class="kw">]])</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span>     tmr.delay<span class="op">(</span> 0.1E6 <span class="op">)</span>            <span class="kw">]])</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span>     gpio.write<span class="op">(</span> led1, gpio.LOW <span class="op">)</span>  <span class="kw">]])</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span>     tmr.delay<span class="op">(</span> 1E6 <span class="op">)</span>              <span class="kw">]])</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span> end                               <span class="kw">]])</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="ex">file.writeline</span><span class="er">(</span><span class="kw">[[</span> print<span class="op">(</span> <span class="st">"Coucou, c'est moi !"</span> <span class="op">)</span>    <span class="kw">]])</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="fu">file.close()</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="exemple-avec-un-mini-serveur-web" class="level2">
<h2 class="anchored" data-anchor-id="exemple-avec-un-mini-serveur-web">Exemple avec un mini serveur web</h2>
<ul>
<li><a href="http://randomnerdtutorials.com/esp8266-web-server/" class="uri">http://randomnerdtutorials.com/esp8266-web-server/</a></li>
</ul>
</section>
<section id="iot" class="level2">
<h2 class="anchored" data-anchor-id="iot">IOT</h2>
<ul>
<li><a href="https://dweet.io">dweet.io</a></li>
<li><a href="https://github.com/mlk/nodemcu-http-client">dweet + NodeMCU</a></li>
<li><a href="https://github.com/Freeboard/freeboard">Freeboard</a></li>
<li><a href="https://www.openhomeautomation.net/internet-of-things-dashboard/" class="uri">https://www.openhomeautomation.net/internet-of-things-dashboard/</a></li>
</ul>
<!--
# ESPTOOL

-   <https://github.com/themadinventor/esptool>

```bash
git clone https://github.com/themadinventor/esptool.git
cd esptool

# affiche les infos du chip
#    Connecting...
#    Manufacturer: e0
#    Device: 4016
#    Le fabricant "e0" n’est pas listé sur http://code.coreboot.org/svn/flashrom/trunk/flashchips.h
./esptool.py -p /dev/tty.wchusbserial1420 -b 9600 flash_id
```


# Flasher un nouveau firmware

```bash
git clone https://github.com/nodemcu/nodemcu-firmware.git
cd esptool
```

-->
</section>
<section id="liens" class="level2">
<h2 class="anchored" data-anchor-id="liens">Liens</h2>
<ul>
<li><a href="https://github.com/nodemcu/nodemcu-firmware/wiki/nodemcu_api_en">NodeMCU API sur GitHub</a></li>
<li><a href="http://www.nodemcu.com/docs/">NodeMCU API sur nodemcu.com</a></li>
<li><a href="https://learn.adafruit.com/adafruit-huzzah-esp8266-breakout?view=all" class="uri">https://learn.adafruit.com/adafruit-huzzah-esp8266-breakout?view=all</a></li>
<li><a href="http://neilkolban.com/tech/esp8266/" class="uri">http://neilkolban.com/tech/esp8266/</a></li>
<li><a href="http://randomnerdtutorials.com/home-automation-using-esp8266/" class="uri">http://randomnerdtutorials.com/home-automation-using-esp8266/</a></li>
<li><a href="https://www.hackster.io/rayburne/esp8266-01-using-arduino-ide" class="uri">https://www.hackster.io/rayburne/esp8266-01-using-arduino-ide</a></li>
<li><a href="http://www.esp8266.com" class="uri">http://www.esp8266.com</a></li>
<li><a href="http://frightanic.com" class="uri">http://frightanic.com</a></li>
<li><a href="http://frightanic.com/iot/comparison-of-esp8266-nodemcu-development-boards/">Comparison of ESP8266 NodeMCU development boards</a></li>
<li><a href="http://www.eluaproject.net">eLua project</a></li>
<li><a href="http://blog.nyl.io/esp8266-motor/" class="uri">http://blog.nyl.io/esp8266-motor/</a></li>
<li><a href="http://hackaday.com/2015/03/18/how-to-directly-program-an-inexpensive-esp8266-wifi-module/" class="uri">http://hackaday.com/2015/03/18/how-to-directly-program-an-inexpensive-esp8266-wifi-module/</a></li>
<li><a href="http://benlo.com/esp8266/esp8266QuickStart.html" class="uri">http://benlo.com/esp8266/esp8266QuickStart.html</a></li>
<li><a href="http://www.allaboutcircuits.com/projects/guts-of-the-iot-part-1-building-nodemcu-from-source-for-the-esp8266/">Building NodeMCU from Source for the ESP8266</a></li>
<li><a href="http://www.allaboutcircuits.com/projects/introduction-to-the-mqtt-protocol-on-nodemcu/">Introduction to the MQTT Protocol on NodeMCU</a></li>
<li><a href="http://www.instructables.com/id/ESP8266-WiFi-File-Management/?ALLSTEPS">ESP8266 WiFi File Management</a></li>
<li><a href="https://fr.wikipedia.org/wiki/Commandes_Hayes">Commandes AT</a></li>
<li><a href="http://internetofhomethings.com/homethings/?p=424">4 reasons I abandoned NodeMCU/Lua for ESP8266, (24th April 2015)</a></li>
<li><a href="http://internetofhomethings.com/homethings/?p=396">4 ways to eliminate ESP8266 resets</a></li>
<li><a href="https://www.youtube.com/watch?v=7h2bE2vNoaY">How To: Pick the right pins on the NodeMCU ESP8266 and ESP32</a> - <a href="https://github.com/thehookup/ESP32_Ceiling_Light/blob/master/GPIO_Limitations_ESP32_NodeMCU.jpg" class="uri">https://github.com/thehookup/ESP32_Ceiling_Light/blob/master/GPIO_Limitations_ESP32_NodeMCU.jpg</a> - <a href="https://github.com/thehookup/Wireless_MQTT_Doorbell/blob/master/GPIO_Limitations_ESP8266_NodeMCU.jpg" class="uri">https://github.com/thehookup/Wireless_MQTT_Doorbell/blob/master/GPIO_Limitations_ESP8266_NodeMCU.jpg</a></li>
</ul>


</section>

<p>© ouilogique.com</p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copié");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copié");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script src="../../js/file_list.js"></script>
<script src="../../js/prev_next_buttons.js"></script>




</body></html>